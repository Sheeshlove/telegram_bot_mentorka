import os
import importlib
import time
from bot_init import bot

# –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞
def load_modules():
    modules = []
    excluded_files = ['run.py', '__init__.py', 'bot_init.py', 'user_management.py', 'snippet.py']
    
    for file in os.listdir():
        if file.endswith('.py') and file not in excluded_files:
            module_name = file[:-3]  # –£–±–∏—Ä–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ .py
            try:
                module = importlib.import_module(module_name)
                modules.append(module)
                print(f"‚úÖ –ú–æ–¥—É–ª—å '{module_name}' —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω")
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è '{module_name}': {e}")
    return modules

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
def run_bot():
    print("ü§ñ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")

    # –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª–∏
    modules = load_modules()

    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–º —Ü–∏–∫–ª–µ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
    while True:
        try:
            # –£–¥–∞–ª—è–µ–º webhook –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º polling
            bot.remove_webhook()
            print("‚úÖ Webhook —É–¥–∞–ª–µ–Ω")

            # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç
            print("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è")
            bot.polling(none_stop=True, interval=0, timeout=60)

        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞: {e}")
            # –ñ–¥–µ–º –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω—ã–º –∑–∞–ø—É—Å–∫–æ–º
            time.sleep(15)
            print("üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞...")

if __name__ == "__main__":
    run_bot()